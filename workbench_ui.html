<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODSL Workbench - åœè«–çš„ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼DSL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            padding: 20px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .sidebar h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .examples-list {
            list-style: none;
        }

        .examples-list li {
            margin-bottom: 10px;
        }

        .example-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 0.95em;
        }

        .example-btn:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }

        .example-btn.active {
            background: #667eea;
            color: white;
        }

        .workspace {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .operations-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .operations-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .operation-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .op-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .op-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .op-btn:active {
            transform: translateY(0);
        }

        .operation-inputs {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .operation-inputs.active {
            display: block;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group select,
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .execute-btn {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .execute-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .visualization-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            min-height: 400px;
        }

        .visualization-area h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .category-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .category-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
        }

        .category-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .category-card .description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .category-card .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .category-card .stat {
            background: #e7f0ff;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .graph-container {
            width: 100%;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
            position: relative;
        }

        .result-display {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #28a745;
        }

        .result-display h4 {
            color: #28a745;
            margin-bottom: 15px;
        }

        .result-json {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .object-node {
            fill: #667eea;
            stroke: #4c5dcc;
            stroke-width: 2;
            cursor: pointer;
        }

        .object-node:hover {
            fill: #764ba2;
        }

        .object-label {
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
        }

        .morphism-arrow {
            stroke: #999;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .morphism-label {
            font-size: 10px;
            fill: #666;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”· CODSL Workbench</h1>
            <p>åœè«–çš„ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼DSL - å¯¾è©±çš„ãƒ¯ãƒ¼ã‚¯ãƒ™ãƒ³ãƒ</p>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <h2>ğŸ“š ä¾‹é¡Œ</h2>
                <ul class="examples-list" id="examplesList">
                    <li><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></li>
                </ul>

                <h2 style="margin-top: 30px;">â• æ–°è¦ä½œæˆ</h2>
                <button class="op-btn" onclick="createNewExample()" style="width: 100%; margin-top: 10px;">
                    æ–°ã—ã„ä¾‹é¡Œ
                </button>
            </aside>

            <main class="workspace">
                <section class="operations-panel">
                    <h3>âš™ï¸ æ¼”ç®—</h3>
                    <div class="operation-buttons">
                        <button class="op-btn" onclick="selectOperation('coproduct')">
                            ç›´å’Œ (A + B)
                        </button>
                        <button class="op-btn" onclick="selectOperation('product')">
                            ç›´ç© (A Ã— B)
                        </button>
                        <button class="op-btn" onclick="selectOperation('difference')">
                            å·®åˆ† (A - B)
                        </button>
                        <button class="op-btn" onclick="selectOperation('pullback')">
                            Pullback
                        </button>
                        <button class="op-btn" onclick="selectOperation('apply_functor')">
                            é–¢æ‰‹é©ç”¨
                        </button>
                    </div>

                    <!-- ç›´å’Œãƒ»ç›´ç©ãƒ»å·®åˆ†ç”¨ -->
                    <div id="binaryOpInputs" class="operation-inputs">
                        <div class="input-group">
                            <label>åœA:</label>
                            <select id="cat1Select"></select>
                        </div>
                        <div class="input-group">
                            <label>åœB:</label>
                            <select id="cat2Select"></select>
                        </div>
                        <button class="execute-btn" onclick="executeOperation()">å®Ÿè¡Œ</button>
                    </div>

                    <!-- Pullbackç”¨ -->
                    <div id="pullbackInputs" class="operation-inputs">
                        <div class="input-group">
                            <label>åœA:</label>
                            <select id="pullbackCat1"></select>
                        </div>
                        <div class="input-group">
                            <label>åœB:</label>
                            <select id="pullbackCat2"></select>
                        </div>
                        <div class="input-group">
                            <label>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåœ:</label>
                            <select id="pullbackTarget"></select>
                        </div>
                        <div class="input-group">
                            <label>é–¢æ‰‹1 (A â†’ Target):</label>
                            <select id="pullbackFunc1"></select>
                        </div>
                        <div class="input-group">
                            <label>é–¢æ‰‹2 (B â†’ Target):</label>
                            <select id="pullbackFunc2"></select>
                        </div>
                        <button class="execute-btn" onclick="executeOperation()">å®Ÿè¡Œ</button>
                    </div>

                    <!-- é–¢æ‰‹é©ç”¨ç”¨ -->
                    <div id="functorInputs" class="operation-inputs">
                        <div class="input-group">
                            <label>é–¢æ‰‹:</label>
                            <select id="functorSelect"></select>
                        </div>
                        <button class="execute-btn" onclick="executeOperation()">å®Ÿè¡Œ</button>
                    </div>
                </section>

                <section class="visualization-area">
                    <div class="tab-container">
                        <button class="tab active" onclick="switchTab('categories', event)">åœã®è¡¨ç¤º</button>
                        <button class="tab" onclick="switchTab('instances', event)">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿</button>
                        <button class="tab" onclick="switchTab('result', event)">å®Ÿè¡Œçµæœ</button>
                    </div>

                    <div id="categoriesTab" class="tab-content active">
                        <h3>ğŸ“Š ç¾åœ¨ã®åœ</h3>
                        <div id="categoryDisplay" class="category-display">
                            <div class="loading">ä¾‹é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                        </div>
                    </div>

                    <div id="instancesTab" class="tab-content">
                        <h3>ğŸ“ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h3>
                        <div id="instancesDisplay">
                            <p style="color: #999; margin-bottom: 20px;">
                                ä¾‹é¡Œã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ã“ã“ã§ç·¨é›†ãƒ»è¨ˆç®—ã§ãã¾ã™
                            </p>

                            <div id="instanceInputArea" style="display: none;">
                                <div style="margin-bottom: 20px; padding: 15px; background: #e7f0ff; border-radius: 6px;">
                                    <h4 style="margin-bottom: 10px;">ğŸ’¡ ä½¿ã„æ–¹</h4>
                                    <ol style="margin-left: 20px; line-height: 1.8;">
                                        <li>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ä»˜ãã®ä¾‹é¡Œã‚’é¸æŠ</li>
                                        <li>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å±æ€§å€¤ã‚’ç·¨é›†ï¼ˆJSONå½¢å¼ï¼‰</li>
                                        <li>ã€Œè¨ˆç®—å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã§GHGæ’å‡ºé‡ã‚’è¨ˆç®—</li>
                                        <li>çµæœãŒã€Œå®Ÿè¡Œçµæœã€ã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œã¾ã™</li>
                                    </ol>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                                        ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚»ãƒƒãƒˆ:
                                    </label>
                                    <select id="instanceSetSelect" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                                    </select>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                                        å¤‰æ›é–¢æ‰‹:
                                    </label>
                                    <select id="computeFunctorSelect" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                                    </select>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                                        ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ (JSON):
                                    </label>
                                    <textarea id="instanceDataInput"
                                              style="width: 100%; height: 300px; padding: 10px;
                                                     border: 2px solid #ddd; border-radius: 6px;
                                                     font-family: 'Courier New', monospace; font-size: 0.9em;">
                                    </textarea>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                                        è¨ˆç®—ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ (æ’å‡ºä¿‚æ•°ãªã©):
                                    </label>
                                    <textarea id="computationContextInput"
                                              style="width: 100%; height: 150px; padding: 10px;
                                                     border: 2px solid #ddd; border-radius: 6px;
                                                     font-family: 'Courier New', monospace; font-size: 0.9em;">
                                    </textarea>
                                </div>

                                <button class="execute-btn" onclick="computeInstances()" style="font-size: 1.1em;">
                                    ğŸ§® è¨ˆç®—å®Ÿè¡Œ
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="resultTab" class="tab-content">
                        <h3>âœ… å®Ÿè¡Œçµæœ</h3>
                        <div id="resultDisplay">
                            <p style="color: #999; text-align: center; padding: 40px;">
                                æ¼”ç®—ã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                            </p>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        let currentExample = null;
        let currentOperation = null;

        // åˆæœŸåŒ–
        async function init() {
            await loadExamples();
        }

        // ä¾‹é¡Œä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadExamples() {
            try {
                const response = await fetch('/api/examples');
                const examples = await response.json();

                const list = document.getElementById('examplesList');
                list.innerHTML = '';

                examples.forEach(example => {
                    const li = document.createElement('li');
                    const btn = document.createElement('button');
                    btn.className = 'example-btn';
                    btn.setAttribute('data-example-name', example.name);
                    btn.innerHTML = `<strong>${example.title}</strong><br><small>${example.description}</small>`;
                    btn.onclick = (event) => loadExample(example.name, event);
                    li.appendChild(btn);
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('ä¾‹é¡Œã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('examplesList').innerHTML =
                    '<li style="color: red;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</li>';
            }
        }

        // ä¾‹é¡Œã‚’èª­ã¿è¾¼ã¿
        async function loadExample(name, event) {
            try {
                const response = await fetch(`/api/example/${name}`);
                currentExample = await response.json();

                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä¾‹é¡Œãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                document.querySelectorAll('.example-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                if (event && event.target) {
                    event.target.classList.add('active');
                } else {
                    // eventãŒãªã„å ´åˆã¯ã€dataå±æ€§ã‹ã‚‰æ¤œç´¢
                    const activeBtn = document.querySelector(`[data-example-name="${name}"]`);
                    if (activeBtn) {
                        activeBtn.classList.add('active');
                    }
                }

                displayCategories();
                updateOperationSelects();
                updateInstanceDisplay();
            } catch (error) {
                console.error('ä¾‹é¡Œã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¾‹é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // åœã‚’è¡¨ç¤º
        function displayCategories() {
            if (!currentExample) return;

            const container = document.getElementById('categoryDisplay');
            container.innerHTML = '';

            currentExample.categories.forEach(cat => {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `
                    <h4>${cat.name}</h4>
                    <div class="description">${cat.description || ''}</div>
                    <div class="stats">
                        <span class="stat">å¯¾è±¡: ${cat.objects.length}</span>
                        <span class="stat">å°„: ${cat.morphisms.length}</span>
                    </div>
                    <div class="graph-container" id="graph-${cat.name}"></div>
                `;
                container.appendChild(card);

                // ã‚°ãƒ©ãƒ•ã‚’æç”»
                setTimeout(() => drawCategoryGraph(cat, `graph-${cat.name}`), 100);
            });
        }

        // åœã®ã‚°ãƒ©ãƒ•ã‚’æç”»ï¼ˆSVGï¼‰
        function drawCategoryGraph(cat, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const width = container.clientWidth;
            const height = container.clientHeight;

            // SVGã‚’ä½œæˆ
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);

            // çŸ¢å°ãƒãƒ¼ã‚«ãƒ¼ã‚’å®šç¾©
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', `arrowhead-${cat.name}`);
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '10');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3');
            marker.setAttribute('orient', 'auto');
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3, 0 6');
            polygon.setAttribute('fill', '#999');
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);

            // å¯¾è±¡ã®ä½ç½®ã‚’è¨ˆç®—ï¼ˆå††å½¢é…ç½®ï¼‰
            const objects = cat.objects;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.35;

            const positions = {};
            objects.forEach((obj, i) => {
                const angle = (i / objects.length) * 2 * Math.PI - Math.PI / 2;
                positions[obj.name] = {
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                };
            });

            // å°„ã‚’æç”»
            cat.morphisms.forEach(morph => {
                if (positions[morph.source] && positions[morph.target]) {
                    const src = positions[morph.source];
                    const tgt = positions[morph.target];

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', src.x);
                    line.setAttribute('y1', src.y);
                    line.setAttribute('x2', tgt.x);
                    line.setAttribute('y2', tgt.y);
                    line.setAttribute('class', 'morphism-arrow');
                    line.setAttribute('marker-end', `url(#arrowhead-${cat.name})`);
                    svg.appendChild(line);
                }
            });

            // å¯¾è±¡ã‚’æç”»
            objects.forEach(obj => {
                const pos = positions[obj.name];

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', pos.x);
                circle.setAttribute('cy', pos.y);
                circle.setAttribute('r', '20');
                circle.setAttribute('class', 'object-node');
                circle.setAttribute('title', obj.semantic || obj.name);
                svg.appendChild(circle);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', pos.x);
                text.setAttribute('y', pos.y + 35);
                text.setAttribute('class', 'object-label');
                text.textContent = obj.name.length > 12 ? obj.name.substring(0, 10) + '...' : obj.name;
                svg.appendChild(text);
            });

            container.innerHTML = '';
            container.appendChild(svg);
        }

        // æ¼”ç®—ã‚’é¸æŠ
        function selectOperation(op) {
            currentOperation = op;

            // ã™ã¹ã¦ã®å…¥åŠ›ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º
            document.querySelectorAll('.operation-inputs').forEach(el => {
                el.classList.remove('active');
            });

            // é¸æŠã—ãŸæ¼”ç®—ã®å…¥åŠ›ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            if (op === 'coproduct' || op === 'product' || op === 'difference') {
                document.getElementById('binaryOpInputs').classList.add('active');
            } else if (op === 'pullback') {
                document.getElementById('pullbackInputs').classList.add('active');
            } else if (op === 'apply_functor') {
                document.getElementById('functorInputs').classList.add('active');
            }
        }

        // æ¼”ç®—ç”¨ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        function updateOperationSelects() {
            if (!currentExample) return;

            const categories = currentExample.categories.map(c => c.name);
            const functors = currentExample.functors || [];

            // äºŒé …æ¼”ç®—ç”¨
            updateSelect('cat1Select', categories);
            updateSelect('cat2Select', categories);

            // Pullbackç”¨
            updateSelect('pullbackCat1', categories);
            updateSelect('pullbackCat2', categories);
            updateSelect('pullbackTarget', categories);
            updateSelect('pullbackFunc1', functors.map(f => f.name));
            updateSelect('pullbackFunc2', functors.map(f => f.name));

            // é–¢æ‰‹ç”¨
            updateSelect('functorSelect', functors.map(f => f.name));
        }

        function updateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = options.map(opt =>
                `<option value="${opt}">${opt}</option>`
            ).join('');
        }

        // æ¼”ç®—ã‚’å®Ÿè¡Œ
        async function executeOperation() {
            if (!currentOperation || !currentExample) return;

            const requestData = {
                operation: currentOperation,
                categories: currentExample.categories,
                functors: currentExample.functors || []
            };

            // æ¼”ç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            if (currentOperation === 'coproduct' || currentOperation === 'product' || currentOperation === 'difference') {
                requestData.cat1 = document.getElementById('cat1Select').value;
                requestData.cat2 = document.getElementById('cat2Select').value;
            } else if (currentOperation === 'pullback') {
                requestData.cat1 = document.getElementById('pullbackCat1').value;
                requestData.cat2 = document.getElementById('pullbackCat2').value;
                requestData.target = document.getElementById('pullbackTarget').value;
                requestData.functor1 = document.getElementById('pullbackFunc1').value;
                requestData.functor2 = document.getElementById('pullbackFunc2').value;
            } else if (currentOperation === 'apply_functor') {
                requestData.functor = document.getElementById('functorSelect').value;
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.innerHTML = '<div class="loading"><div class="spinner"></div>å®Ÿè¡Œä¸­...</div>';
            switchTab('result');

            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.error) {
                    resultDisplay.innerHTML = `
                        <div class="error">
                            <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${result.error}
                        </div>
                    `;
                } else {
                    displayResult(result);
                }
            } catch (error) {
                resultDisplay.innerHTML = `
                    <div class="error">
                        <strong>å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // çµæœã‚’è¡¨ç¤º
        function displayResult(result) {
            const resultDisplay = document.getElementById('resultDisplay');

            let html = '<div class="result-display">';

            if (currentOperation === 'apply_functor') {
                html += `
                    <h4>ğŸ”„ é–¢æ‰‹é©ç”¨çµæœ</h4>
                    <div class="stats" style="margin-bottom: 15px;">
                        <span class="stat">é–¢æ‰‹: ${result.functor}</span>
                        <span class="stat">ã‚½ãƒ¼ã‚¹: ${result.source}</span>
                        <span class="stat">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${result.target}</span>
                        <span class="stat" style="background: ${result.is_valid ? '#d4edda' : '#f8d7da'}">
                            ${result.is_valid ? 'âœ“ æœ‰åŠ¹' : 'âœ— ç„¡åŠ¹'}
                        </span>
                    </div>
                `;

                if (!result.is_valid) {
                    html += '<div class="error" style="margin-bottom: 15px;"><strong>æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:</strong><ul>';
                    result.validation_errors.forEach(err => {
                        html += `<li>${err}</li>`;
                    });
                    html += '</ul></div>';
                }

                html += '<h5>å¯¾è±¡ãƒãƒƒãƒ”ãƒ³ã‚°:</h5><ul>';
                for (const [src, tgt] of Object.entries(result.object_mappings)) {
                    html += `<li>${src} â†’ ${tgt}</li>`;
                }
                html += '</ul>';

                html += '<h5>å°„ãƒãƒƒãƒ”ãƒ³ã‚°:</h5><ul>';
                for (const [src, tgt] of Object.entries(result.morphism_mappings)) {
                    html += `<li>${src} â†’ ${tgt}</li>`;
                }
                html += '</ul>';
            } else {
                html += `
                    <h4>ğŸ“Š ${getOperationName(currentOperation)}ã®çµæœ</h4>
                    <div class="stats" style="margin-bottom: 15px;">
                        <span class="stat">åœå: ${result.name}</span>
                        <span class="stat">å¯¾è±¡æ•°: ${result.object_count}</span>
                        <span class="stat">å°„æ•°: ${result.morphism_count}</span>
                    </div>
                    <h5>å¯¾è±¡ä¸€è¦§:</h5>
                    <ul>
                `;
                result.objects.slice(0, 10).forEach(obj => {
                    html += `<li><strong>${obj.name}</strong> (${obj.domain}): ${obj.semantic}</li>`;
                });
                if (result.objects.length > 10) {
                    html += `<li><em>...ä»– ${result.objects.length - 10} ä»¶</em></li>`;
                }
                html += '</ul>';
            }

            html += '<h5>JSONå‡ºåŠ›:</h5>';
            html += `<div class="result-json">${JSON.stringify(result, null, 2)}</div>`;
            html += '</div>';

            resultDisplay.innerHTML = html;
        }

        function getOperationName(op) {
            const names = {
                'coproduct': 'ç›´å’Œ (A + B)',
                'product': 'ç›´ç© (A Ã— B)',
                'difference': 'å·®åˆ† (A - B)',
                'pullback': 'Pullback',
                'apply_functor': 'é–¢æ‰‹é©ç”¨'
            };
            return names[op] || op;
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // eventãŒãªã„å ´åˆã¯ã€ã‚¿ãƒ–åã‹ã‚‰é©åˆ‡ãªã‚¿ãƒ–ã‚’è¦‹ã¤ã‘ã‚‹
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach((tab, index) => {
                    if ((tabName === 'categories' && index === 0) ||
                        (tabName === 'instances' && index === 1) ||
                        (tabName === 'result' && index === 2)) {
                        tab.classList.add('active');
                    }
                });
            }

            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateInstanceDisplay() {
            if (!currentExample || !currentExample.instances) {
                document.getElementById('instanceInputArea').style.display = 'none';
                return;
            }

            document.getElementById('instanceInputArea').style.display = 'block';

            // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚»ãƒƒãƒˆã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const instanceSetSelect = document.getElementById('instanceSetSelect');
            instanceSetSelect.innerHTML = '';
            Object.keys(currentExample.instances).forEach(setName => {
                const option = document.createElement('option');
                option.value = setName;
                option.textContent = setName;
                instanceSetSelect.appendChild(option);
            });

            // é–¢æ‰‹ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const functorSelect = document.getElementById('computeFunctorSelect');
            functorSelect.innerHTML = '';
            (currentExample.functors || []).forEach(functor => {
                const option = document.createElement('option');
                option.value = functor.name;
                option.textContent = `${functor.name} (${functor.source} â†’ ${functor.target})`;
                functorSelect.appendChild(option);
            });

            // æœ€åˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
            const firstSetName = Object.keys(currentExample.instances)[0];
            if (firstSetName) {
                displayInstanceSet(firstSetName);
            }

            // è¨ˆç®—ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
            if (currentExample.computation_context) {
                document.getElementById('computationContextInput').value =
                    JSON.stringify(currentExample.computation_context, null, 2);
            }

            // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚»ãƒƒãƒˆé¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            instanceSetSelect.onchange = (e) => {
                displayInstanceSet(e.target.value);
            };
        }

        // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
        function displayInstanceSet(setName) {
            if (!currentExample || !currentExample.instances || !currentExample.instances[setName]) {
                return;
            }

            const instanceSet = currentExample.instances[setName];
            document.getElementById('instanceDataInput').value =
                JSON.stringify(instanceSet, null, 2);
        }

        // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨ˆç®—ã‚’å®Ÿè¡Œ
        async function computeInstances() {
            if (!currentExample) {
                alert('ä¾‹é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const instanceSetName = document.getElementById('instanceSetSelect').value;
            const functorName = document.getElementById('computeFunctorSelect').value;

            if (!instanceSetName || !functorName) {
                alert('ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚»ãƒƒãƒˆã¨é–¢æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let instanceData, computationContext;
            try {
                instanceData = JSON.parse(document.getElementById('instanceDataInput').value);
                computationContext = JSON.parse(document.getElementById('computationContextInput').value);
            } catch (e) {
                alert('JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ' + e.message);
                return;
            }

            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const requestData = {
                categories: currentExample.categories,
                functors: currentExample.functors,
                instances: {},
                source_instance_set: instanceSetName,
                functor: functorName,
                computation_context: computationContext
            };

            // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            requestData.instances[instanceSetName] = instanceData;

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.innerHTML = '<div class="loading"><div class="spinner"></div>è¨ˆç®—ä¸­...</div>';
            switchTab('result');

            try {
                const response = await fetch('/api/compute_instances', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    displayComputationResult(result);
                } else {
                    resultDisplay.innerHTML = `
                        <div class="error">
                            <strong>è¨ˆç®—ã‚¨ãƒ©ãƒ¼:</strong> ${result.error}<br>
                            <pre style="margin-top: 10px; white-space: pre-wrap;">${result.traceback || ''}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDisplay.innerHTML = `
                    <div class="error">
                        <strong>å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // è¨ˆç®—çµæœã‚’è¡¨ç¤º
        function displayComputationResult(result) {
            const resultDisplay = document.getElementById('resultDisplay');

            let html = '<div class="result-display">';
            html += '<h4>ğŸ§® GHGæ’å‡ºé‡è¨ˆç®—çµæœ</h4>';

            // ã‚µãƒãƒªãƒ¼
            html += '<div style="margin: 20px 0; padding: 20px; background: #e7f5e7; border-radius: 8px;">';
            html += '<h5 style="margin-bottom: 15px;">ğŸ“Š æ’å‡ºé‡ã‚µãƒãƒªãƒ¼</h5>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
            html += `<div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666;">æ—¥æ¬¡æ’å‡ºé‡</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #d32f2f;">
                            ${result.results.total_emissions_daily.toFixed(2)}
                        </div>
                        <div style="font-size: 0.9em; color: #666;">${result.results.unit_daily}</div>
                     </div>`;
            html += `<div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666;">å¹´é–“æ’å‡ºé‡ï¼ˆæ¨å®šï¼‰</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #d32f2f;">
                            ${result.results.total_emissions_annual.toFixed(2)}
                        </div>
                        <div style="font-size: 0.9em; color: #666;">${result.results.unit_annual}</div>
                     </div>`;
            html += '</div></div>';

            // æ’å‡ºæºè©³ç´°
            html += '<h5 style="margin: 20px 0 10px 0;">ğŸ“ æ’å‡ºæºåˆ¥å†…è¨³</h5>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
            html += '<thead><tr style="background: #f5f5f5;">';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">æ’å‡ºæº</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">å…ƒè¨­å‚™</th>';
            html += '<th style="padding: 10px; text-align: right; border: 1px solid #ddd;">æ’å‡ºé‡</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">ã‚«ãƒ†ã‚´ãƒª</th>';
            html += '</tr></thead><tbody>';

            result.results.emission_details.forEach(detail => {
                html += '<tr>';
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${detail.name}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${detail.source || '-'}</td>`;
                html += `<td style="padding: 10px; text-align: right; border: 1px solid #ddd; font-weight: bold;">
                           ${detail.emission_amount.toFixed(2)} ${detail.unit}
                         </td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${detail.category}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            // JSONå‡ºåŠ›
            html += '<h5 style="margin: 20px 0 10px 0;">ğŸ“„ JSONå‡ºåŠ›</h5>';
            html += `<div class="result-json">${JSON.stringify(result, null, 2)}</div>`;
            html += '</div>';

            resultDisplay.innerHTML = html;
        }

        // æ–°è¦ä¾‹é¡Œä½œæˆ
        function createNewExample() {
            alert('æ–°è¦ä¾‹é¡Œä½œæˆæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚\nç¾åœ¨ã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ä½œæˆã—ã¦ãã ã•ã„ã€‚');
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>
</html>
